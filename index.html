<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Inventory Management System - Python Flask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen p-6">
        <div class="max-w-full mx-auto px-4">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">IT Inventory Management System</h1>
                <p class="text-gray-600">Python Flask + SQLite Database</p>
            </div>

            <!-- Alerts -->
            <div id="alerts"></div>

            <!-- Stats Cards -->
            <div id="stats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"></div>

            <!-- Controls -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-1 relative">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Cari kode aset, nama, serial number..."
                            class="w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <select id="filterCategory" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="all">Semua Kategori</option>
                        <option value="Laptop">Laptop</option>
                        <option value="Desktop">Desktop</option>
                        <option value="Server">Server</option>
                        <option value="Network">Network</option>
                        <option value="Printer">Printer</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <select id="filterStatus" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="all">Semua Status</option>
                        <option value="Aktif">Aktif</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Rusak">Rusak</option>
                        <option value="Retired">Retired</option>
                    </select>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="openModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ‚ûï Tambah Aset
                    </button>
                    <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Export CSV
                    </button>
                    <label class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 cursor-pointer">
                        üì§ Import CSV
                        <input type="file" id="importFile" accept=".csv" class="hidden" />
                    </label>
                    <button onclick="showCharts()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        üìä Dashboard
                    </button>
                    <button onclick="showHistory()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        üìù History
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Brand/Model</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lokasi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="assetTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold">Tambah Aset</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Kode Aset</label>
                            <input type="text" id="assetCode" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Nama Aset *</label>
                            <input type="text" id="name" class="w-full px-3 py-2 border rounded-lg" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Kategori</label>
                            <select id="category" class="w-full px-3 py-2 border rounded-lg">
                                <option>Laptop</option>
                                <option>Desktop</option>
                                <option>Server</option>
                                <option>Network</option>
                                <option>Printer</option>
                                <option>Mobile</option>
                                <option>Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Brand</label>
                            <input type="text" id="brand" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Model</label>
                            <input type="text" id="model" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Serial Number</label>
                            <input type="text" id="serialNumber" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Status</label>
                            <select id="status" class="w-full px-3 py-2 border rounded-lg">
                                <option>Aktif</option>
                                <option>Maintenance</option>
                                <option>Rusak</option>
                                <option>Retired</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Lokasi</label>
                            <select id="location" class="w-full px-3 py-2 border rounded-lg">
                                <option>Jakarta</option>
                                <option>Bandung</option>
                                <option>Surabaya</option>
                                <option>Yogyakarta</option>
                                <option>Bali</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Assigned To</label>
                            <input type="text" id="assignedTo" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email Pengguna</label>
                            <input type="email" id="userEmail" placeholder="user@company.com" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tanggal Beli</label>
                            <input type="date" id="purchaseDate" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Warranty End</label>
                            <input type="date" id="warrantyEnd" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Harga (Rp)</label>
                            <input type="number" id="price" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Catatan</label>
                        <textarea id="notes" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveAsset()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üíæ Simpan
                        </button>
                        <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Modal -->
    <div id="chartsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Dashboard Analytics</h2>
                    <button onclick="closeCharts()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-4">Per Kategori</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-4">Per Status</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-4">Per Lokasi</h3>
                        <canvas id="locationChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-4">Nilai per Kategori</h3>
                        <canvas id="valueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">History & Audit Log</h2>
                    <button onclick="closeHistory()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
                <div class="overflow-y-auto max-h-[60vh]">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase">Timestamp</th>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase">Action</th>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase">Asset</th>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase">Details</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAssetId = null;
        let currentPage = 1;
        let itemsPerPage = 10;
        let allAssets = [];

        // Load assets
        async function loadAssets() {
            const search = document.getElementById('searchInput').value;
            const category = document.getElementById('filterCategory').value;
            const status = document.getElementById('filterStatus').value;

            const params = new URLSearchParams({
                search: search,
                category: category,
                status: status
            });

            const response = await fetch(`/api/assets?${params}`);
            allAssets = await response.json();

            renderTable();
        }

        function renderTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAssets = allAssets.slice(startIndex, endIndex);
            const totalPages = Math.ceil(allAssets.length / itemsPerPage);

            const tbody = document.getElementById('assetTable');
            tbody.innerHTML = paginatedAssets.map(asset => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">${asset.assetCode}</td>
                    <td class="px-6 py-4">${asset.name}</td>
                    <td class="px-6 py-4">${asset.category}</td>
                    <td class="px-6 py-4">${asset.brand} ${asset.model}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(asset.status)}">
                            ${asset.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">${asset.location || '-'}</td>
                    <td class="px-6 py-4">${asset.assignedTo || '-'}</td>
                    <td class="px-6 py-4 text-sm text-blue-600">${asset.userEmail || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick="editAsset(${asset.id})" class="text-blue-600 hover:text-blue-800">‚úèÔ∏è</button>
                            <button onclick="deleteAsset(${asset.id})" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                            <a href="/api/qrcode/${asset.id}" target="_blank" class="text-green-600 hover:text-green-800">üì±</a>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Update pagination info
            updatePagination(totalPages);
        }

        function updatePagination(totalPages) {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, allAssets.length);
            
            const paginationHTML = `
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Menampilkan ${startIndex} - ${endIndex} dari ${allAssets.length} aset
                    </div>
                    <div class="flex gap-2 items-center">
                        <button
                            onclick="changePage(${currentPage - 1})"
                            ${currentPage === 1 ? 'disabled' : ''}
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ‚Üê Previous
                        </button>
                        <span class="px-4 py-2 text-sm text-gray-600">
                            Halaman ${currentPage} dari ${totalPages || 1}
                        </span>
                        <button
                            onclick="changePage(${currentPage + 1})"
                            ${currentPage >= totalPages ? 'disabled' : ''}
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            `;

            // Find and update pagination container
            const table = document.querySelector('table').closest('.bg-white');
            const existingPagination = table.querySelector('.border-t');
            if (existingPagination) {
                existingPagination.outerHTML = paginationHTML;
            } else {
                table.insertAdjacentHTML('beforeend', paginationHTML);
            }
        }

        function changePage(page) {
            const totalPages = Math.ceil(allAssets.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Load stats
        async function loadStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            document.getElementById('stats').innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Total Aset</div>
                    <div class="text-3xl font-bold text-blue-600">${stats.total}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Aktif</div>
                    <div class="text-3xl font-bold text-green-600">${stats.active}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Maintenance</div>
                    <div class="text-3xl font-bold text-yellow-600">${stats.maintenance}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Rusak</div>
                    <div class="text-3xl font-bold text-red-600">${stats.broken}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Warranty Alert</div>
                    <div class="text-3xl font-bold text-orange-600">${stats.warrantyAlerts}</div>
                </div>
            `;

            if (stats.warrantyAlerts > 0) {
                document.getElementById('alerts').innerHTML = `
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                        <p class="text-sm text-yellow-700">
                            ‚ö†Ô∏è <strong>Peringatan:</strong> ${stats.warrantyAlerts} aset warranty akan habis dalam 30 hari
                        </p>
                    </div>
                `;
            }
        }

        function getStatusColor(status) {
            const colors = {
                'Aktif': 'bg-green-100 text-green-800',
                'Maintenance': 'bg-yellow-100 text-yellow-800',
                'Rusak': 'bg-red-100 text-red-800',
                'Retired': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-blue-100 text-blue-800';
        }

        function openModal() {
            currentAssetId = null;
            document.getElementById('modalTitle').textContent = 'Tambah Aset Baru';
            document.getElementById('modal').classList.remove('hidden');
            clearForm();
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function clearForm() {
            document.getElementById('assetCode').value = '';
            document.getElementById('name').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('model').value = '';
            document.getElementById('serialNumber').value = '';
            document.getElementById('assignedTo').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('purchaseDate').value = '';
            document.getElementById('warrantyEnd').value = '';
            document.getElementById('price').value = '';
            document.getElementById('notes').value = '';
        }

        async function saveAsset() {
            const data = {
                assetCode: document.getElementById('assetCode').value,
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                brand: document.getElementById('brand').value,
                model: document.getElementById('model').value,
                serialNumber: document.getElementById('serialNumber').value,
                status: document.getElementById('status').value,
                location: document.getElementById('location').value,
                assignedTo: document.getElementById('assignedTo').value,
                userEmail: document.getElementById('userEmail').value,
                purchaseDate: document.getElementById('purchaseDate').value,
                warrantyEnd: document.getElementById('warrantyEnd').value,
                price: document.getElementById('price').value,
                notes: document.getElementById('notes').value
            };

            if (!data.name) {
                alert('Nama aset wajib diisi!');
                return;
            }

            const url = currentAssetId ? `/api/assets/${currentAssetId}` : '/api/assets';
            const method = currentAssetId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal();
                loadAssets();
                loadStats();
                alert('Aset berhasil disimpan!');
            }
        }

        async function editAsset(id) {
            const response = await fetch(`/api/assets?search=`);
            const assets = await response.json();
            const asset = assets.find(a => a.id === id);

            if (asset) {
                currentAssetId = id;
                document.getElementById('modalTitle').textContent = 'Edit Aset';
                document.getElementById('assetCode').value = asset.assetCode;
                document.getElementById('name').value = asset.name;
                document.getElementById('category').value = asset.category;
                document.getElementById('brand').value = asset.brand || '';
                document.getElementById('model').value = asset.model || '';
                document.getElementById('serialNumber').value = asset.serialNumber || '';
                document.getElementById('status').value = asset.status;
                document.getElementById('location').value = asset.location || '';
                document.getElementById('assignedTo').value = asset.assignedTo || '';
                document.getElementById('userEmail').value = asset.userEmail || '';
                document.getElementById('purchaseDate').value = asset.purchaseDate || '';
                document.getElementById('warrantyEnd').value = asset.warrantyEnd || '';
                document.getElementById('price').value = asset.price || '';
                document.getElementById('notes').value = asset.notes || '';
                document.getElementById('modal').classList.remove('hidden');
            }
        }

        async function deleteAsset(id) {
            if (!confirm('Yakin ingin menghapus aset ini?')) return;

            const response = await fetch(`/api/assets/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadAssets();
                loadStats();
                alert('Aset berhasil dihapus!');
            }
        }

        async function exportCSV() {
            window.location.href = '/api/export';
        }

        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/import', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadAssets();
                loadStats();
            }
        });

        async function showCharts() {
            document.getElementById('chartsModal').classList.remove('hidden');
            
            const response = await fetch('/api/charts');
            const data = await response.json();

            new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.category),
                    datasets: [{ data: Object.values(data.category), backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6B7280'] }]
                }
            });

            new Chart(document.getElementById('statusChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.status),
                    datasets: [{ label: 'Jumlah', data: Object.values(data.status), backgroundColor: '#3B82F6' }]
                }
            });

            new Chart(document.getElementById('locationChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(data.location),
                    datasets: [{ data: Object.values(data.location), backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'] }]
                }
            });

            new Chart(document.getElementById('valueChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.value),
                    datasets: [{ label: 'Total Nilai (Rp)', data: Object.values(data.value), backgroundColor: '#10B981' }]
                }
            });
        }

        function closeCharts() {
            document.getElementById('chartsModal').classList.add('hidden');
        }

        async function showHistory() {
            document.getElementById('historyModal').classList.remove('hidden');
            
            const response = await fetch('/api/history');
            const logs = await response.json();

            document.getElementById('historyTable').innerHTML = logs.map(log => `
                <tr class="border-b">
                    <td class="px-4 py-3 text-sm">${new Date(log.timestamp).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            log.action === 'CREATE' ? 'bg-green-100 text-green-800' :
                            log.action === 'UPDATE' ? 'bg-blue-100 text-blue-800' :
                            log.action === 'DELETE' ? 'bg-red-100 text-red-800' :
                            'bg-purple-100 text-purple-800'
                        }">${log.action}</span>
                    </td>
                    <td class="px-4 py-3 font-medium">${log.assetCode}</td>
                    <td class="px-4 py-3 text-sm">${log.details}</td>
                </tr>
            `).join('');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            loadAssets();
        });
        document.getElementById('filterCategory').addEventListener('change', () => {
            currentPage = 1;
            loadAssets();
        });
        document.getElementById('filterStatus').addEventListener('change', () => {
            currentPage = 1;
            loadAssets();
        });

        // Initial load
        loadAssets();
        loadStats();
    </script>
</body>
</html>
